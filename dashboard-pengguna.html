<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pengguna - MobileApp</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-top">
                <div class="user-info">
                    <div class="user-avatar">
                        <svg width="32" height="32" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                        </svg>
                    </div>
                    <div class="user-details">
                        <h3 id="userName">Loading...</h3>
                        <span id="userStatus" class="status-badge">Pengguna Biasa</span>
                    </div>
                </div>
                <div class="header-right">
                    <div class="balance-display" onclick="showBottomTab('topup')">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M4 10a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H4zM3 6v3a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2z"/>
                            <path d="M2 4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4zm10-1H4a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1zM8 6a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H7a.5.5 0 0 1-.5-.5v-1A.5.5 0 0 1 7 6h1z"/>
                        </svg>
                        <span id="headerBalance">Rp 0</span>
                    </div>
                    <button class="logout-btn" onclick="logout()">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                            <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Navigation -->
            <div class="top-nav">
                <button class="nav-item active" onclick="filterByCategory('all')">Semua</button>
                <button class="nav-item" onclick="filterByCategory('horor')">Horor</button>
                <button class="nav-item" onclick="filterByCategory('komedi')">Komedi</button>
                <button class="nav-item" onclick="filterByCategory('adventure')">Adventure</button>
                <button class="nav-item" onclick="filterByCategory('romantis')">Romantis</button>
                <button class="nav-item" onclick="filterByCategory('ftv')">FTV</button>
                <button class="nav-item" onclick="filterByCategory('anak')">Anak-Anak</button>
            </div>

            <!-- Hero Banner -->
            <div class="hero-banner">
                <div class="hero-content">
                    <div class="hero-badge">üî¥ Live ‚Ä¢ Film ‚Ä¢ Premium Content</div>
                    <h1 class="hero-title">Film Premium Tersedia</h1>
                    <h2 class="hero-subtitle">Streaming Berkualitas HD</h2>
                    <p class="hero-date">Setiap hari | Akses 24/7</p>
                    <button class="hero-cta" onclick="scrollToMovies()">
                        ‚ñ∂ Mulai Nonton
                    </button>
                    <div class="hero-indicators">
                        <span class="indicator active"></span>
                        <span class="indicator"></span>
                        <span class="indicator"></span>
                        <span class="indicator"></span>
                        <span class="indicator"></span>
                    </div>
                </div>
            </div>

            <!-- Premium Package Section -->
            <div class="premium-section">
                <h3 class="section-title">Bebas Pilih Paket Sesukamu</h3>
                <div class="premium-packages">
                    <div class="package-card featured">
                        <div class="package-image">
                            <div class="play-overlay">‚ñ∂</div>
                        </div>
                        <div class="package-info">
                            <h4>Premium Access</h4>
                            <p>Nonton SEMUA film tanpa batas dengan kualitas HD</p>
                            <div class="package-price">Upgrade Rp.25.000</div>
                            <div class="balance-info-inline">
                                <span>Saldo: <strong id="userBalance">Rp 0</strong></span>
                            </div>
                        </div>
                        <div class="package-badge premium">HD</div>
                    </div>
                    
                    <div class="package-card">
                        <div class="package-image sport">
                            <div class="play-overlay">‚ñ∂</div>
                        </div>
                        <div class="package-info">
                            <h4>Film Terbaru</h4>
                            <p>Akses film-film terbaru dengan subtitle Indonesia</p>
                            <div class="package-price">29.000</div>
                        </div>
                        <div class="package-badge new">NEW</div>
                    </div>
                </div>
            </div>

            <!-- Movies Grid Section -->
            <div class="movies-section">
                <div class="section-header-with-arrow">
                    <h3 class="section-title">Hari Ini Pasti Menang</h3>
                    <button class="section-arrow">‚ùØ</button>
                </div>
                <div id="moviesList" class="movies-grid-layout">
                    <div class="loading-card cinema">
                        <div class="loading-spinner"></div>
                        <p>Memuat koleksi film...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content Sections -->
        <div id="topupContent" class="tab-content" style="display: none;">
            <div class="section-header">
                <h2>Top Up Saldo</h2>
                <p>Isi saldo Anda untuk membeli film premium</p>
            </div>
            <div class="current-balance">
                <div class="balance-card">
                    <div class="balance-info">
                        <span class="balance-label">Saldo Saat Ini</span>
                        <span id="currentBalance" class="balance-amount">Rp 0</span>
                    </div>
                </div>
            </div>
            <div class="topup-options">
                <h3>Pilih Nominal Top Up</h3>
                <div class="topup-amounts">
                    <button class="topup-btn" onclick="selectTopupAmount(10000)">Rp 10.000</button>
                    <button class="topup-btn" onclick="selectTopupAmount(25000)">Rp 25.000</button>
                    <button class="topup-btn" onclick="selectTopupAmount(50000)">Rp 50.000</button>
                    <button class="topup-btn" onclick="selectTopupAmount(100000)">Rp 100.000</button>
                    <button class="topup-btn" onclick="selectTopupAmount(250000)">Rp 250.000</button>
                    <button class="topup-btn" onclick="selectTopupAmount(500000)">Rp 500.000</button>
                </div>
                <div class="custom-amount">
                    <input type="number" id="customAmount" placeholder="Masukkan nominal custom" min="5000" max="1000000">
                    <button onclick="useCustomAmount()">Gunakan</button>
                </div>
                <div class="selected-amount" id="selectedAmount" style="display: none;">
                    <p>Nominal dipilih: <span id="selectedValue">Rp 0</span></p>
                    <button class="confirm-topup-btn" onclick="processTopup()">Konfirmasi Top Up</button>
                </div>
            </div>
        </div>

        <div id="chatContent" class="tab-content" style="display: none;">
            <div class="section-header">
                <h2>Customer Service</h2>
                <p>Chat dengan tim support kami</p>
            </div>
            <div class="chat-container">
                <div class="chat-messages" id="chatMessagesNew">
                    <div class="message support-message">
                        <div class="message-avatar">CS</div>
                        <div class="message-content">
                            <p>Halo! Selamat datang di customer service MobileApp. Ada yang bisa kami bantu?</p>
                            <span class="message-time">Sekarang</span>
                        </div>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" id="chatInputNew" placeholder="Ketik pesan Anda..." onkeypress="handleChatKeyPress(event)">
                    <button onclick="sendMessage()" class="send-btn">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M15.854.146a.5.5 0 0 1 .11.54L13.026 8.13 7.5 6.937l-1.193-5.523a.5.5 0 0 1 .54-.11l8.607 1.844zm-5.372 6.9L7.5 8.6 1.73 7.19A.5.5 0 0 1 1.5 6.7l.014-.034L6.56 3.644l3.922 3.352z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div id="profileContent" class="tab-content" style="display: none;">
            <div class="section-header">
                <h2>Profil Saya</h2>
                <p>Kelola informasi akun Anda</p>
            </div>
            <div class="profile-info">
                <div class="profile-card">
                    <div class="profile-avatar">
                        <svg width="60" height="60" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                        </svg>
                    </div>
                    <div class="profile-details">
                        <h3 id="profileName">Loading...</h3>
                        <p id="profileEmail">Loading...</p>
                        <span id="profileStatus" class="status-badge">Pengguna Biasa</span>
                    </div>
                </div>
                <div class="profile-actions">
                    <button class="profile-btn" onclick="editProfile()">Edit Profil</button>
                    <button class="profile-btn" onclick="changePassword()">Ubah Password</button>
                    <button class="profile-btn premium-btn" onclick="requestPremium()">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                        </svg>
                        Upgrade ke Premium
                    </button>
                </div>
            </div>
        </div>

        <div id="premiumContent" class="tab-content" style="display: none;">
            <div class="section-header">
                <h2>Premium Membership</h2>
                <p>Nikmati akses tak terbatas ke semua film premium</p>
            </div>
            <div class="premium-benefits">
                <div class="benefit-card">
                    <div class="benefit-icon">üé¨</div>
                    <h4>Akses Unlimited</h4>
                    <p>Nonton semua film premium tanpa batas</p>
                </div>
                <div class="benefit-card">
                    <div class="benefit-icon">üéØ</div>
                    <h4>Kualitas HD</h4>
                    <p>Streaming dengan kualitas video terbaik</p>
                </div>
                <div class="benefit-card">
                    <div class="benefit-icon">‚ö°</div>
                    <h4>Tanpa Iklan</h4>
                    <p>Menonton tanpa gangguan iklan</p>
                </div>
            </div>
            <div class="premium-action">
                <button class="premium-upgrade-btn" onclick="requestPremium()">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                    </svg>
                    Request Premium Access
                </button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="bottom-nav-item active" onclick="showBottomTab('home')">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5v7a.5.5 0 0 0 .5.5h4.5a.5.5 0 0 0 .5-.5v-4h2v4a.5.5 0 0 0 .5.5H14a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.146-.354L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.354 1.146zM2.5 14V7.707l5.5-5.5 5.5 5.5V14H10v-4a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5v4H2.5z"/>
                </svg>
                <span>Beranda</span>
            </button>
            <button class="bottom-nav-item" onclick="showBottomTab('topup')">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M1 3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1H1zM7 5.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zM2 2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H2z"/>
                </svg>
                <span>Top Up</span>
            </button>
            <button class="bottom-nav-item" onclick="showBottomTab('chat')">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
                </svg>
                <span>Chat</span>
            </button>
            <button class="bottom-nav-item" onclick="showBottomTab('profile')">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                    <path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                </svg>
                <span>Profil</span>
            </button>
            <button class="bottom-nav-item" onclick="showBottomTab('premium')">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                </svg>
                <span>Premium</span>
            </button>
        </div>

        <!-- Tab Content (Hidden sections for other tabs) -->
        <div class="tab-content-hidden" style="display: none;">
            <!-- Chat Tab -->
            <div id="chatTab" class="tab-pane">

            <!-- Chat Tab -->
            <div id="chatTab" class="tab-pane">
                <div class="chat-container">
                    <div class="chat-header">
                        <h3>Live Chat dengan Admin</h3>
                        <button class="btn btn-outline btn-sm" onclick="loadChatMessages()">Refresh</button>
                    </div>
                    <div id="chatMessages" class="chat-messages">
                        <div class="loading-card">
                            <div class="loading-spinner"></div>
                            <p>Memuat pesan...</p>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <form id="chatForm" class="chat-form">
                            <input type="text" id="chatInput" placeholder="Ketik pesan Anda..." required>
                            <button type="submit" class="btn btn-primary">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M15.854.146a.5.5 0 0 1 .11.54L13.026 8l2.938 7.314a.5.5 0 0 1-.538.685l-13-2a.5.5 0 0 1-.38-.619l2-8a.5.5 0 0 1 .947-.205L13.026 8 .933 1.175a.5.5 0 0 1-.38-.619l2-8A.5.5 0 0 1 3 .146l13 2z"/>
                                </svg>
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="profileTab" class="tab-pane">
                <div class="profile-card">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                            </svg>
                        </div>
                        <h3 id="profileUserName">Loading...</h3>
                        <p id="profileUserEmail">Loading...</p>
                    </div>
                    
                    <div class="profile-stats">
                        <div class="stat-item">
                            <span class="stat-label">Status</span>
                            <span id="profileStatus" class="stat-value">Pengguna Biasa</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Saldo</span>
                            <span id="profileBalance" class="stat-value">Rp 0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Bergabung</span>
                            <span id="profileJoinDate" class="stat-value">-</span>
                        </div>
                    </div>

                    <div class="profile-actions">
                        <button class="btn btn-outline btn-full" onclick="showPremiumModal()">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                            </svg>
                            Upgrade ke Premium
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Voucher Modal -->
    <div id="voucherModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Tukar Voucher</h3>
                <span class="close" onclick="closeModal('voucherModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="voucherForm">
                    <div class="form-group">
                        <label for="voucherCode">Kode Voucher</label>
                        <input type="text" id="voucherCode" placeholder="Masukkan kode voucher" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Tukar Voucher</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Premium Modal -->
    <div id="premiumModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Upgrade Premium</h3>
                <span class="close" onclick="closeModal('premiumModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="premium-info">
                    <h4>Keuntungan Premium:</h4>
                    <ul>
                        <li>Akses unlimited ke semua film</li>
                        <li>Kualitas video HD</li>
                        <li>Download untuk offline</li>
                        <li>Priority customer support</li>
                    </ul>
                </div>
                <button class="btn btn-primary btn-full" onclick="requestPremium()">Ajukan Upgrade Premium</button>
            </div>
        </div>
        
        <footer class="page-footer">
            <p>&copy; 2025 Dikembangkan oleh <span id="developer-name" class="developer-link">Arvin Erlangga.M.Sc.IT</span></p>
        </footer>
    </div>

    <!-- Admin Access Modal -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Admin Access</h3>
                <span class="close" onclick="closeModal('adminModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="adminForm">
                    <div class="form-group">
                        <label for="adminCode">Masukkan Kode Akses:</label>
                        <input type="password" id="adminCode" placeholder="Kode akses rahasia" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Masuk sebagai Admin</button>
                </form>
            </div>
        </div>
    </div>

    <div id="errorToast" class="toast error"></div>
    <div id="successToast" class="toast success"></div>

    <script src="script.js"></script>
    <script>
        let currentUser = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadUserProfile();
            loadMovies();
            loadChatMessages();
        });

        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetch('/api/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                    return;
                }

                currentUser = await response.json();
                updateUserDisplay();
            } catch (error) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            }
        }

        function updateUserDisplay() {
            const userName = document.getElementById('userName');
            const userStatus = document.getElementById('userStatus');
            const userBalance = document.getElementById('userBalance');
            const profileUserName = document.getElementById('profileUserName');
            const profileUserEmail = document.getElementById('profileUserEmail');
            const profileStatus = document.getElementById('profileStatus');
            const profileBalance = document.getElementById('profileBalance');
            
            if (userName) userName.textContent = currentUser.username;
            if (userStatus) {
                userStatus.textContent = currentUser.is_premium ? 'Premium' : 'Pengguna Biasa';
                userStatus.className = `status-badge ${currentUser.is_premium ? 'premium' : ''}`;
            }
            if (userBalance) userBalance.textContent = `Rp ${Number(currentUser.balance || 0).toLocaleString('id-ID')}`;
            
            // Profile tab elements (might not exist in new layout)
            if (profileUserName) profileUserName.textContent = currentUser.username;
            if (profileUserEmail) profileUserEmail.textContent = currentUser.email;
            if (profileStatus) profileStatus.textContent = currentUser.is_premium ? 'Premium' : 'Pengguna Biasa';
            if (profileBalance) profileBalance.textContent = `Rp ${Number(currentUser.balance || 0).toLocaleString('id-ID')}`;
        }

        async function loadUserProfile() {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch('/api/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    currentUser = await response.json();
                    updateUserDisplay();
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        async function loadMovies() {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch('/api/movies', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const movies = await response.json();
                displayMovies(movies);
            } catch (error) {
                document.getElementById('moviesList').innerHTML = `
                    <div class="error-card">
                        <p>Gagal memuat film</p>
                    </div>
                `;
            }
        }

        function displayMovies(movies) {
            const moviesList = document.getElementById('moviesList');
            
            if (movies.length === 0) {
                moviesList.innerHTML = `
                    <div class="empty-state cinema">
                        <div class="empty-icon">üé¨</div>
                        <h3>Belum Ada Film</h3>
                        <p>Koleksi film sedang dalam proses penambahan</p>
                        <small>Periksa kembali nanti untuk update terbaru</small>
                    </div>
                `;
                return;
            }

            moviesList.innerHTML = movies.map((movie, index) => `
                <div class="cinema-card" data-movie-id="${movie.id}">
                    <div class="movie-poster-container">
                        <div class="movie-poster cinema">
                            <div class="poster-overlay">
                                <div class="play-button" onclick="playMovie('${movie.google_drive_url}', '${movie.title}')">
                                    <svg width="24" height="24" fill="white" viewBox="0 0 16 16">
                                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                        <path d="M6.271 5.055a.5.5 0 0 1 .52.026L11 7.055a.5.5 0 0 1 0 .89L6.791 9.929a.5.5 0 0 1-.791-.39V5.46a.5.5 0 0 1 .271-.405z"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="movie-backdrop">
                                <div class="movie-gradient"></div>
                                <div class="movie-title-overlay">${movie.title}</div>
                            </div>
                        </div>
                        <div class="movie-badge ${currentUser && currentUser.is_premium ? 'premium' : 'free'}">
                            ${currentUser && currentUser.is_premium ? 'HD' : 'SD'}
                        </div>
                    </div>
                    <div class="cinema-info">
                        <h4 class="movie-title">${movie.title}</h4>
                        <p class="movie-description">${movie.description || 'Drama menarik dengan alur cerita yang menguras emosi'}</p>
                        <div class="movie-meta">
                            <span class="rating">‚≠ê 8.${Math.floor(Math.random() * 9) + 1}</span>
                            <span class="duration">‚Ä¢ ${90 + Math.floor(Math.random() * 60)} min</span>
                            <span class="year">‚Ä¢ 202${Math.floor(Math.random() * 5)}</span>
                        </div>
                        <div class="movie-actions">
                            <button class="btn-watch-now" onclick="playMovie('${movie.google_drive_url}', '${movie.title}')">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                    <path d="M6.271 5.055a.5.5 0 0 1 .52.026L11 7.055a.5.5 0 0 1 0 .89L6.791 9.929a.5.5 0 0 1-.791-.39V5.46a.5.5 0 0 1 .271-.405z"/>
                                </svg>
                                Tonton Sekarang
                            </button>
                            <button class="btn-add-list" onclick="addToWatchlist(${movie.id})">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function playMovie(url, title) {
            // Convert Google Drive URL to direct streaming URL
            const streamUrl = convertGoogleDriveUrl(url);
            showVideoPlayer(streamUrl, title);
        }
        
        function convertGoogleDriveUrl(url) {
            // Convert Google Drive share URL to direct streaming URL
            if (url.includes('drive.google.com')) {
                const fileId = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
                if (fileId) {
                    return `https://drive.google.com/file/d/${fileId[1]}/preview`;
                }
            }
            return url;
        }
        
        function showVideoPlayer(url, title) {
            const modal = document.createElement('div');
            modal.className = 'video-modal';
            modal.innerHTML = `
                <div class="video-modal-content">
                    <div class="video-header">
                        <h3>${title}</h3>
                        <button class="close-video" onclick="closeVideoPlayer()">&times;</button>
                    </div>
                    <div class="video-container">
                        <iframe 
                            src="${url}" 
                            frameborder="0" 
                            allowfullscreen
                            allow="autoplay; encrypted-media"
                            class="video-player">
                        </iframe>
                    </div>
                    <div class="video-controls">
                        <button class="video-btn" onclick="toggleFullscreen()">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/>
                            </svg>
                            Fullscreen
                        </button>
                        <button class="video-btn" onclick="shareMovie('${title}')">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M13.5 1a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5zm-8.5 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm11 5.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3z"/>
                            </svg>
                            Share
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
            
            // Show modal with animation
            setTimeout(() => {
                modal.classList.add('active');
            }, 10);
            
            // Add keyboard event listeners
            document.addEventListener('keydown', handleVideoKeyboard);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeVideoPlayer();
                }
            });
        }
        
        function closeVideoPlayer() {
            const modal = document.querySelector('.video-modal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
                document.removeEventListener('keydown', handleVideoKeyboard);
                setTimeout(() => {
                    if (document.body.contains(modal)) {
                        document.body.removeChild(modal);
                    }
                }, 300);
            }
        }
        
        function handleVideoKeyboard(e) {
            if (e.key === 'Escape') {
                closeVideoPlayer();
            } else if (e.key === 'f' || e.key === 'F') {
                toggleFullscreen();
            }
        }
        
        function toggleFullscreen() {
            const iframe = document.querySelector('.video-player');
            if (iframe.requestFullscreen) {
                iframe.requestFullscreen();
            } else if (iframe.webkitRequestFullscreen) {
                iframe.webkitRequestFullscreen();
            } else if (iframe.msRequestFullscreen) {
                iframe.msRequestFullscreen();
            }
        }
        
        function shareMovie(title) {
            if (navigator.share) {
                navigator.share({
                    title: `Nonton ${title}`,
                    text: `Sedang menonton film ${title} di aplikasi kami`,
                    url: window.location.href
                });
            } else {
                // Fallback for browsers that don't support Web Share API
                const url = window.location.href;
                navigator.clipboard.writeText(url).then(() => {
                    showSuccess('Link berhasil disalin ke clipboard');
                });
            }
        }
        
        function addToWatchlist(movieId) {
            showSuccess('Film ditambahkan ke daftar tonton');
        }
        
        function showSection(section) {
            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function scrollToMovies() {
            document.querySelector('.movies-section').scrollIntoView({ behavior: 'smooth' });
        }

        async function loadChatMessages() {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch('/api/chat', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const messages = await response.json();
                displayChatMessages(messages);
            } catch (error) {
                document.getElementById('chatMessages').innerHTML = `
                    <div class="error-card">
                        <p>Gagal memuat pesan</p>
                    </div>
                `;
            }
        }

        function displayChatMessages(messages) {
            const chatMessages = document.getElementById('chatMessages');
            
            if (messages.length === 0) {
                chatMessages.innerHTML = `
                    <div class="empty-state">
                        <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414L2 13.414V2a1 1 0 0 1 1-1h11zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353L4.707 11H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                        </svg>
                        <p>Belum ada pesan. Mulai percakapan dengan admin!</p>
                    </div>
                `;
                return;
            }

            chatMessages.innerHTML = messages.map(message => `
                <div class="chat-message ${message.is_admin ? 'admin' : 'user'}">
                    <div class="message-content">
                        <p>${message.message}</p>
                        <span class="message-time">${new Date(message.created_at).toLocaleString('id-ID')}</span>
                    </div>
                    <div class="message-avatar">
                        ${message.is_admin ? 'Admin' : (message.username || 'Anda')}
                    </div>
                </div>
            `).join('');

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Chat form submission
        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const message = document.getElementById('chatInput').value.trim();
            if (!message) return;

            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ message })
                });

                if (response.ok) {
                    document.getElementById('chatInput').value = '';
                    loadChatMessages(); // Reload messages
                } else {
                    showError('Gagal mengirim pesan');
                }
            } catch (error) {
                showError('Terjadi kesalahan jaringan');
            }
        });

        // Voucher form submission
        document.getElementById('voucherForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const code = document.getElementById('voucherCode').value.trim();
            if (!code) return;

            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/redeem-voucher', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ code })
                });

                const data = await response.json();

                if (response.ok) {
                    showSuccess(`Voucher berhasil ditukar! Saldo bertambah Rp ${Number(data.amount).toLocaleString('id-ID')}`);
                    closeModal('voucherModal');
                    loadUserProfile(); // Reload profile to update balance
                } else {
                    showError(data.error || 'Gagal menukar voucher');
                }
            } catch (error) {
                showError('Terjadi kesalahan jaringan');
            }
        });

        async function requestPremium() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/request-premium', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showSuccess('Permintaan upgrade premium berhasil dikirim. Admin akan meninjau dalam 1-2 hari kerja.');
                    closeModal('premiumModal');
                } else {
                    showError(data.error || 'Gagal mengajukan premium');
                }
            } catch (error) {
                showError('Terjadi kesalahan jaringan');
            }
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-pane').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        function showVoucherModal() {
            document.getElementById('voucherModal').style.display = 'block';
        }

        function showPremiumModal() {
            document.getElementById('premiumModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // Admin access functionality
        document.getElementById('developer-name').addEventListener('click', () => {
            document.getElementById('adminModal').style.display = 'block';
        });

        document.getElementById('adminForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = document.getElementById('adminCode').value;
            
            try {
                const response = await fetch('/api/admin-login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code })
                });

                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    window.location.href = 'dashboard-admin.html';
                } else {
                    showError(data.error || 'Kode akses tidak valid');
                }
            } catch (error) {
                showError('Terjadi kesalahan jaringan');
            }
        });

        // Auto-refresh chat every 30 seconds
        setInterval(loadChatMessages, 30000);
    </script>
</body>
</html>
